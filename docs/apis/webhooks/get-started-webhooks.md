# Basic SharePoint webhooks tutorial

## Summary
This basic tutorial will show you how to add and handle SharePoint webhook requests. We will be using Postman client to construct and execute SharePoint webhook requests quickly while interacting with a simple ASP.NET Web API as the webhook receiver. 

This is a raw version executing plain HTTP requests. It is useful to understand how webhooks work under the hood (see also a [recorded demo](https://www.youtube.com/watch?v=IbVlDkmsh8w "Tutorial demo on YouTube") of this tutorial). If you are looking for an end to end ASP.NET sample, then you can find it [here](https://aka.ms/sp-webhooks-sample-reference).

## Prerequisites

To complete this basic SharePoint webhooks tutorial, you will need to download and install the following tools.

* [Google Chrome Browser](http://google.com/chrome)
* [Postman](https://www.getpostman.com/)
* [Visual Studio Community Edition](https://go.microsoft.com/fwlink/?LinkId=691978&clcid=0x409)
* [ngrok](https://ngrok.com/)
  * Follow the instructions [here](https://ngrok.com/download) to install ngrok.
* Office 365 Subscription with SharePoint Online

If you are new to Office 365, you can also sign up for an Office 365 developer account: <http://dev.office.com/devprogram>

## Step 1: Register AAD application for Postman client
In order for the Postman client to talk to SharePoint, you will need to register an Azure Active Directory (AAD) app in your Azure AD tenant associated with your Office 365 tenant. 

To access SharePoint online, it's important to grant the AAD app permissions to _Office 365 SharePoint Online_ application and select the following permission:
* read and write items and lists in all site collections

> Read [here](https://azure.microsoft.com/en-us/documentation/articles/active-directory-integrating-applications/#adding-an-application) for more information on adding an AAD application and granting permissions to applications. 

Enter the following endpoint as the Reply (Redirect) URL for the app. This is the endpoint to which AAD will send the authentication response, including the access token if authentication was successful.

```html
https://www.getpostman.com/oauth2/callback
```

The following properties are required later in the tutorials, so copy them in a safe place:

* Client Id
* Client Secret 

## Step 2: Build webhook receiver
We will use Visual Studio Web API project to build the webhook receiver.

### Create a new ASP.NET Web API project
* Open Visual Studio
* Select New Project from the _File->New->Project_.
* In the _Templates_ pane, select _Installed Templates_ and expand the _Visual C#_ node. 
* Under Visual C#, select Web. In the list of project templates, select _ASP.NET Web Application_. 
* Name the project _SPWebhooksReceiver_ and click _OK_.
* In the New ASP.NET Project dialog, select the _Web API_ template from _ASP.NET 4.5.\*_ group. 
* Change the authentication to _No Authentication_ by clicking the _Change Authentication_ button.
* Click _OK_ to create the Web API project.

> NOTE: You can Un-check the *Host in the cloud* option as we will not deploy the project to the cloud.

* Visual Studio will create your project.

### Webhook receiver

#### Install Nuget packages
We will use ASP.NET Web API Tracing to log the requests coming from SharePoint. Follow the steps to install the tracing package:

* Switch to *Solution Explorer* in Visual Studio.
* Right click on the project and select *Manage Nuget Packages...*.
* In the search box, type *Microsoft.AspNet.WebApi.Tracing* 
* In the search results, select *Microsoft.AspNet.WebApi.Tracing*  package and click *Install* to install the package

#### SPWebhookNotification model
Each notification generated by the service is serialized into a webhookNotifiation instance. Lets build a simple model that represents this notification instance:

* Switch to *Solution Explorer* in Visual Studio.
* Right click on the *Models* folder and select *Add->Class*.
* Enter `SPWebhookNotification` as the class name and click `Add` to add the class to your project.
* Add the following to the body of the `SPWebhookNotification` class:

	```cs
	public string SubscriptionId { get; set; }

	public string ClientState { get; set; }

	public string ExpirationDateTime { get; set; }

	public string Resource { get; set; }

	public string TenantId { get; set; }

	public string SiteUrl { get; set; }

	public string WebId { get; set; }
	```

#### SPWebhookContent model
Since multiple notifications may be submitted to your webhook receiver in a single request, these are combined together in an object with a single array value. Lets build a simple model that represents this array:

* Switch to *Solution Explorer* in Visual Studio.
* Right click on the *Models* folder and select *Add->Class*.
* Enter `SPWebhookContent` as the class name and click `Add` to add the class to your project.
* Add the following to the body of the `SPWebhookContent` class:

	```cs
	 public List<SPWebhookNotification> Value { get; set; }
	```

#### SharePoint webhook client state
Webhooks provide the ability to use an optional string value that is passed back in the notification message for your subscription. This can be used to verify if the request is indeed coming from the source you trust, in this case, SharePoint. 

Lets add a client state value with which we will verify the incoming requests:

* Switch to *Solution Explorer* in Visual Studio.
* Open *web.config* file and add the following key as the client state to `<appSettings>` section:

	```xml
	<add key="webhookclientstate" value="A0A354EC-97D4-4D83-9DDB-144077ADB449"/>
	```

#### Enable tracing
In the *web.config* file, enable tracing by adding the following key inside the `<system.web>` element in the `<configuration>` section:

```xml
<trace enabled="true"/>
```

Adding a trace writer to the controller configuration (we'll use the one from `System.Diagnostics`) is required:

* Switch to *Solution Explorer* in Visual Studio.
* Open *WebApiConfig.cs*, which is in the *App_Start* folder.
* Add the following line inside the `Register` method:

	```cs
	config.EnableSystemDiagnosticsTracing();
	```

#### SharePoint webhook controller
Now its time to build the webhook receiver controller which will handle the incoming requests from SharePoint and act/respond accordingly.

* Switch to *Solution Explorer* in Visual Studio.
* Right click on the *Controllers* folder and select *Add->Controller*.
* In the *Add Scaffold* dialog, select *Web API 2 Controller - Empty*.
* Click *Add*.
* Name the controller *SPWebhookController* and click *Add* to add the API controller to your project.
* Replace the `using` statements with the following:

	```cs
	using Newtonsoft.Json;
	using SPWebhooksReceiver.Models;
	using System.Collections.Generic;
	using System.Configuration;
	using System.Linq;
	using System.Net;
	using System.Net.Http;
	using System.Threading.Tasks;
	using System.Web;
	using System.Web.Http;
	using System.Web.Http.Tracing;
	```

* Replace the code in the *SPWebhookController* class with the following:

	```cs
	[HttpPost]
	public HttpResponseMessage HandleRequest()
	{
	    HttpResponseMessage httpResponse = new HttpResponseMessage(HttpStatusCode.BadRequest);
	    var traceWriter = Configuration.Services.GetTraceWriter();
	    string validationToken = string.Empty;
	    IEnumerable<string> clientStateHeader = new List<string>();
	    string webhookClientState = ConfigurationManager.AppSettings["webhookclientstate"].ToString();

	    if (Request.Headers.TryGetValues("ClientState", out clientStateHeader))
	    {
	        string clientStateHeaderValue = clientStateHeader.FirstOrDefault() ?? string.Empty;

	        if (!string.IsNullOrEmpty(clientStateHeaderValue) && clientStateHeaderValue.Equals(webhookClientState))
	        {
	            traceWriter.Trace(Request, "SPWebhooks", 
	                TraceLevel.Info, 
	                string.Format("Received client state: {0}", clientStateHeaderValue));

	            var queryStringParams = HttpUtility.ParseQueryString(Request.RequestUri.Query);

	            if (queryStringParams.AllKeys.Contains("validationtoken"))
	            {
	                httpResponse = new HttpResponseMessage(HttpStatusCode.OK);
	                validationToken = queryStringParams.GetValues("validationtoken")[0].ToString();
	                httpResponse.Content = new StringContent(validationToken);

	                traceWriter.Trace(Request, "SPWebhooks", 
	                    TraceLevel.Info, 
	                    string.Format("Received validation token: {0}", validationToken));                        
	                return httpResponse;
	            }
	            else
	            {
	                var requestContent = Request.Content.ReadAsStringAsync().Result;

	                if (!string.IsNullOrEmpty(requestContent))
	                {
	                    SPWebhookNotification notification = null;

	                    try
	                    {
	                        var objNotification = JsonConvert.DeserializeObject<SPWebhookContent>(requestContent);
	                        notification = objNotification.Value[0];
	                    }
	                    catch (JsonException ex)
	                    {
	                        traceWriter.Trace(Request, "SPWebhooks", 
	                            TraceLevel.Error, 
	                            string.Format("JSON deserialization error: {0}", ex.InnerException));
	                        return httpResponse;
	                    }

	                    if (notification != null)
	                    {
	                        Task.Factory.StartNew(() =>
	                        {
	                             //handle the notification here
	                             //you can send this to an Azure queue to be processed later
	                            //for this sample, we just log to the trace

	                            traceWriter.Trace(Request, "SPWebhook Notification", 
	                                TraceLevel.Info, string.Format("Resource: {0}", notification.Resource));
	                            traceWriter.Trace(Request, "SPWebhook Notification", 
	                                TraceLevel.Info, string.Format("SubscriptionId: {0}", notification.SubscriptionId));
	                            traceWriter.Trace(Request, "SPWebhook Notification", 
	                                TraceLevel.Info, string.Format("TenantId: {0}", notification.TenantId));
	                            traceWriter.Trace(Request, "SPWebhook Notification", 
	                                TraceLevel.Info, string.Format("SiteUrl: {0}", notification.SiteUrl));
	                            traceWriter.Trace(Request, "SPWebhook Notification", 
	                                TraceLevel.Info, string.Format("WebId: {0}", notification.WebId));
	                            traceWriter.Trace(Request, "SPWebhook Notification", 
	                                TraceLevel.Info, string.Format("ExpirationDateTime: {0}", notification.ExpirationDateTime));

	                        });

	                        httpResponse = new HttpResponseMessage(HttpStatusCode.OK);
	                    }
	                }
	            }
	        }
	        else
	        {
	            httpResponse = new HttpResponseMessage(HttpStatusCode.Forbidden);
	        }
	    }

	    return httpResponse;
	}
	```

* Save the file

## Step 3: Debug the webhook receiver
* Press *F5* to debug the webhook receiver.
* Once you have the browser open, copy the port number in which it is served from the address bar. For example: `http://localhost:port-number`.

## Step 4: Run ngrok proxy

* Open a console terminal.
* Navigate to the extracted ngrok folder.
* Type the following with the *port-number* from the previous step to start ngrok:

	```
	./ngrok http port-number --host-header=localhost:port-number
	```

* You should see ngrok running.
* Copy the *Forwarding* HTTPS address. We will use this address as our service proxy for SharePoint to send requests. 

## Step 5: Add webhook subscription using Postman

### Get new access token
Postman makes it really simple to work with APIs. The first step is to configure Postman to authenticate with AAD so we can send API requests to SharePoint. We will use the AAD app we registered in Step 1.

* Open Postman
* You will be presented with a _Sidebar_ and _Request Editor_
* Click _Authorization_ tab in the _Request Editor_
* Select _OAuth 2.0_ in the Type dropdown
* Click the *Get New Access Token* button
* In the dialog window, enter the following: 
    * Auth URL: 
       * ```https://login.microsoftonline.com/common/oauth2/authorize?resource=https%3A%2F%2Fpaste-your-sharepoint-site-collection-url-without-https ```
       * Replace `paste-your-sharepoint-site-collection-url-without-https` with your site collection without the `https` prefix.
    * Access Token URL:
        * ```https://login.microsoftonline.com/common/oauth2/token```
    * Client Id: 
        * Client Id of the app you registered previously in Step 1.
    * Client Secret: 
        * Client Secret of the app you registered previously in Step 1.
    * Token name:
        * sp_webhooks_token
    * Grant type:
        * Authorization Code
* Click the _Request Token_ to sign in, consent and get the token for the session.
* Once the token is successfully retrieved, you should see _access\_token_ variable added to the _Authorization_ tab
* Select the option to _Add token to header_.
* Double click on the _access\_token_ variable to add the token to the header for the request.

![postman get new access token](../../../../images/postman-get-new-access-token.png)

### Get Documents list Id
We will manage webhooks for the default document library which is provisioned by default in your default site collection under the name `Documents`. Lets get the Id of this list by issuing a `GET` request:

* Enter the following request URL

> Replace site-collection with your site collection

	```
	https://site-collection/_api/web/lists/getbytitle('Documents')?$select=Title,Id
	```
	
Postman will execute your request and if successful, you should see the result.

Copy the *Id* from the results.

We will use this *Id* to make webhook requests.   

### Add webhook subscription
Now that we have the required information, we can construct the query and the request to add a webhook subscription. In the request editor:

* Change the request to `POST` from `GET`
* Enter the following as the request URL:

	```
	https://site-collection/_api/web/lists('list-id')/subscriptions
	```

* Switch to *Headers* tab
   * Make sure you still have the *Authorization* header. If not, you wil need to request a new access token.
   * Add the following header *key -> value* pairs:
      * Accept -> application/json;odata=nometadata
      * Content-Type -> application/json

* Switch to *Body* tab and select *raw* Format
* Paste the following as the body:

	```
	{
	  "resource": "https://site-collection/_api/web/lists('list-id')",
	  "notificationUrl": "https://ngrok-forwarding-address/api/spwebhook/handlerequest",
	  "expirationDateTime": "2016-10-27T16:17:57+00:00",
	  "clientState": "A0A354EC-97D4-4D83-9DDB-144077ADB449"
	}
	```

	![postman add webhook body](../../../../images/postman-add-webhook-body.png)

> Make sure the expirationDateTime is at most 6 months from today. 

* Make sure you are debugging the webhook receiver as we did in Step 4.
* Click *Send* to execute the request.
* If the request is successful, you should see the response from SharePoint that provides the subscription details. Example response below:

	```json
	{
	  "clientState": "A0A354EC-97D4-4D83-9DDB-144077ADB449",
	  "expirationDateTime": "2016-10-27T16:17:57Z",
	  "id": "32b95d9-4d20-4a17-bfa3-2957cb38ead8",
	  "notificationUrl": "https://85557d4b.ngrok.io/api/spwebhook/handlerequest",
	  "resource": "c34420f9-2ad7-4e54-94c9-b67798d2299b"
	}
	```

* Copy the subscription *id* as we will need it in the next set of requests.
* Switch to webhook receiver project in Visual Studio and notice in the Output window. You should see our trace logs, something like this along with other messages:

	```
	iisexpress.exe Information: 0 : Message='Received client state: A0A354EC-97D4-4D83-9DDB-144077ADB449'
	iisexpress.exe Information: 0 : Message='Received validation token: daf2803c-43cf-44c7-8dff-7066eaa40f13'
	```

This indicates that the webhook received initially received a validation request. If you look at the code, we return the validation token immediately so SharePoint can validate this request:

```cs
if (queryStringParams.AllKeys.Contains("validationtoken"))
{
    httpResponse = new HttpResponseMessage(HttpStatusCode.OK);
    validationToken = queryStringParams.GetValues("validationtoken")[0].ToString();
    httpResponse.Content = new StringContent(validationToken);

    traceWriter.Trace(Request, "SPWebhooks", 
        TraceLevel.Info, 
        string.Format("Received validation token: {0}", validationToken));                        
    return httpResponse;
}
```

## Step 6: Get subscription details
Switch to Postman client. Lets now execute queries to get the subscription details.

To get the details of all the subscriptions, enter and execute the following query in Postman:

* Change the request to `GET` from `POST`
* Enter the following as the request:

	```
	https://site-collection/_api/web/lists('list-id')/subscriptions
	```

* Click *Send* to execute the request
* If successful, you should see SharePoint return the subscriptions for this list resource. Since we just added one, you should at least see one subscription returned. Example response:

	```json
	{
	  "value": [
	    {
	      "clientState": "A0A354EC-97D4-4D83-9DDB-144077ADB449",
	      "expirationDateTime": "2016-10-27T16:17:57Z",
	      "id": "32b95add-4d20-4a17-bfa3-2957cb38ead8",
	      "notificationUrl": "https://85557d4b.ngrok.io/api/spwebhook/handlerequest",
	      "resource": "c34420f9-2a67-4e54-94c9-b67798229f9b"
	    }
	  ]
	}
	```

You can execute the following query to get details of the specific subscription:

> Replace subscription-id with your subscription id 

	```
	https://site-collection/_api/web/lists('list-id')/subscriptions('subscription-id')
	```

## Step 7: Test webhook notification
Lets now add a file to the Documents library and test if we get a notification from SharePoint in our webhook receiver.

* Switch to Visual Studio.
* In the *SPWebhookController* Place a breakpoint in the following line:

	```cs
	var requestContent = Request.Content.ReadAsStringAsync().Result;
	```

* Navigate to the *Documents* library, this will be *Shared Documents* library in your default site collection, and add a new file.
* Once added, swtich to Visual Studio and wait for the breakpoint to be hit.
   * In preview, the wait time may vary from few seconds and up to 5 mins.
* Once the breakpoint is hit, this means, webhook receiver has just received a notification from SharePoint.
* Press *F5* to continue.
* To see the notification data, look in the *Output* window for the following as we added the notification data into the trace log. You should see something like this:

	```
	iisexpress.exe Information: 0 : Message='Resource: c34420f9-2a67-4e54-94c9-b6770892299b'
	iisexpress.exe Information: 0 : Message='SubscriptionId: 32b95ad9-4d20-4a17-bfa3-2957cb38ead8'
	iisexpress.exe Information: 0 : Message='TenantId: 7a17cb7d-6898-423f-8839-45f363076f06'
	iisexpress.exe Information: 0 : Message='SiteUrl: /'
	iisexpress.exe Information: 0 : Message='WebId: 62b80e0b-f889-4974-a519-cc138413be40'
	iisexpress.exe Information: 0 : Message='ExpirationDateTime: 2016-10-27T16:17:57.0000000Z'
	```

In this tutorial, we are simply writing the information to the trace log. However, in your receiver, you will send this information into a table or a queue that can process the received data to get information from SharePoint. 

With this data, you can construct the URL and use the GetChanges API to get the latest changes.

## Next steps
In this tutorial, we used Postman client and a simple Web API to subscribe and receive webhook notification from SharePoint. 

Next, you can browse an [end to end sample walkthrough which uses Azure Storage Queues](https://aka.ms/sp-webhooks-sample-reference "Reference implementation") to process the information, get changes from SharePoint and push those back into a SharePoint list.
